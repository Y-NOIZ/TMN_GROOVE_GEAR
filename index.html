<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>TMN Live Gear</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <style>
    table.dataTable thead th {
      text-align: center;
    }
    .live-logo, .live-checkbox-label {
      width: 48px;
      height: 48px;
      object-fit: contain;
      cursor: pointer;
      transition: opacity 0.3s;
    }
    .live-logo:not(.active) {
      opacity: 0.3;
    }
    .dt-left {
      text-align: left;
    }
    .toggle-container {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

<div class="toggle-container">
  <label>
    <input type="checkbox" id="toggleView" checked>
    縮小表示オン/オフ
  </label>
</div>

<table id="gearTable" class="display" style="width:100%">
  <thead>
    <tr id="headerRow">
      <th>ジャンル</th>
      <th>メーカー</th>
      <th>機材名</th>
      <th class="live-header" data-live="RHYTHM RED TMN TOUR"></th>
      <th class="live-header" data-live="TOUR TMN EXPO"></th>
      <th class="live-header" data-live="TOUR TMN EXPO FINAL CRAZY 4 YOU"></th>
      <th class="live-header" data-live="TMN 4001 DAYS GROOVE"></th>
      <th>備考</th>
    </tr>
  </thead>
</table>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script>
$(document).ready(function() {
  const liveInfos = [
    { name: "RHYTHM RED TMN TOUR", short: "RRTT.svg" },
    { name: "TOUR TMN EXPO", short: "TTE.svg" },
    { name: "TOUR TMN EXPO FINAL CRAZY 4 YOU", short: "C4U.svg" },
    { name: "TMN 4001 DAYS GROOVE", short: "LG.svg" }
  ];

  const liveColumnIndexMap = {
    "RHYTHM RED TMN TOUR": 3,
    "TOUR TMN EXPO": 4,
    "TOUR TMN EXPO FINAL CRAZY 4 YOU": 5,
    "TMN 4001 DAYS GROOVE": 6
  };

  function fetchCSVData(url, callback) {
    $.ajax({
      url: url,
      dataType: 'text'
    }).done(function(csv) {
      const lines = csv.split('\n').filter(line => line.trim() !== '');
      const headers = lines[0].split(',');
      const data = lines.slice(1).map(line => {
        const cols = line.split(',');
        return {
          ジャンル: cols[0],
          メーカー: cols[1],
          機材名: cols[2],
          RHYTHM: cols[3],
          EXPO: cols[4],
          CRAZY: cols[5],
          GROOVE: cols[6],
          備考: cols[7]
        };
      });
      callback(data);
    });
  }

  function updateHeader(viewModeIcon) {
    $('.live-header').each(function(index) {
      const info = liveInfos[index];
      if (viewModeIcon) {
        $(this).html(`<img src="logos/${info.short}" class="live-logo live-filter active" data-live="${info.name}">`);
      } else {
        $(this).html(`<label><input type="checkbox" class="live-checkbox live-filter" data-live="${info.name}" checked> ${info.name}</label>`);
      }
    });
  }

  fetchCSVData('TMN_GROOVE_GEAR.csv', function(dataSet) {
    const table = $('#gearTable').DataTable({
      paging: false,
      info: false,
      data: dataSet,
      columns: [
        { data: 'ジャンル' },
        { data: 'メーカー' },
        { data: '機材名' },
        { data: 'RHYTHM', className: 'dt-center' },
        { data: 'EXPO', className: 'dt-center' },
        { data: 'CRAZY', className: 'dt-center' },
        { data: 'GROOVE', className: 'dt-center' },
        { data: '備考', className: 'dt-left' }
      ],
      order: []
    });

    updateHeader(true);

    $(document).on('click', '.live-logo', function() {
      $(this).toggleClass('active');
      table.draw();
    });

    $(document).on('change', '.live-checkbox', function() {
      table.draw();
    });

    $('#toggleView').on('change', function() {
      const isIconView = $(this).is(':checked');
      updateHeader(isIconView);
    });

    $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
      let activeLives = [];
      if ($('#toggleView').is(':checked')) {
        activeLives = $('.live-logo.active').map(function() {
          return $(this).data('live');
        }).get();
      } else {
        activeLives = $('.live-checkbox:checked').map(function() {
          return $(this).data('live');
        }).get();
      }

      if (activeLives.length === 0) return true;

      return activeLives.every(live => {
        const colIndex = liveColumnIndexMap[live];
        return data[colIndex] === '✓';
      });
    });
  });
});
</script>

</body>
</html>
